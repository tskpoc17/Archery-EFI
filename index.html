<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archery EFI Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #targetCanvas { border-radius: 50%; cursor: crosshair; background: #fdfdfd; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-red-600">射箭箭群 EFI 評估系統</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">參數設置</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium">S (靶面分數範圍):</label>
                        <input type="number" id="paramS" value="10" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">D (靶面直徑 cm):</label>
                        <input type="number" id="paramD" value="80" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">K (距離修正係數):</label>
                        <input type="number" id="paramK" value="1" step="0.1" class="w-full border p-2 rounded">
                    </div>
                    <button onclick="resetAll()" class="w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition">清空數據</button>
                </div>
                
                <div class="mt-8">
                    <h2 class="text-xl font-semibold mb-2 border-b pb-2">數據統計</h2>
                    <p>著箭數: <span id="arrowCount">0</span></p>
                    <div id="results" class="mt-4 space-y-2 hidden">
                        <div class="p-3 bg-red-50 rounded border border-red-200">
                            <p class="font-bold text-red-700">水平 EFI (X): <span id="efix">0</span></p>
                            <p class="font-bold text-red-700">垂直 EFI (Y): <span id="efiy">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 flex flex-col items-center">
                <canvas id="targetCanvas" width="500" height="500"></canvas>
                <p class="mt-4 text-gray-500 text-sm">※ 點擊靶面位置標記箭點，系統將以靶心為 (0,0)</p>
                
                <div id="suggestionBox" class="mt-6 w-full bg-blue-50 p-6 rounded-xl border border-blue-200 hidden">
                    <h2 class="text-xl font-bold text-blue-800 mb-2">瞄準器調整建議</h2>
                    <p id="suggestionText" class="text-lg text-blue-700 font-medium"></p>
                </div>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('targetCanvas');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    let arrows = [];

    // 初始化畫靶
    function drawTarget() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const colors = ['#ffffff', '#ffffff', '#000000', '#000000', '#00bfff', '#00bfff', '#ff0000', '#ff0000', '#ffff00', '#ffff00'];
        const ringWidth = canvas.width / 20;
        
        for (let i = 0; i < 10; i++) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, (10 - i) * ringWidth, 0, Math.PI * 2);
            ctx.fillStyle = colors[i];
            ctx.fill();
            ctx.strokeStyle = '#ccc';
            ctx.stroke();
        }
        
        // 畫中心線
        ctx.beginPath();
        ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height);
        ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY);
        ctx.strokeStyle = 'rgba(0,0,0,0.1)';
        ctx.stroke();

        // 畫點
        arrows.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.px, p.py, 5, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.stroke();
        });
    }

    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const px = e.clientX - rect.left;
        const py = e.clientY - rect.top;
        
        // 轉換為實際座標 (以中心為0, 比例縮放)
        const D = parseFloat(document.getElementById('paramD').value);
        const scale = D / canvas.width;
        const x = (px - centerX) * scale;
        const y = (centerY - py) * scale; // Y軸向上為正

        arrows.push({ x, y, px, py });
        updateAnalysis();
        drawTarget();
    });

    function calculateEFI(values, S, D, K) {
        if (values.length < 2) return 0;
        
        const n = values.length;
        const mean = values.reduce((a, b) => a + b, 0) / n;
        
        const rightGroup = values.filter(v => v >= mean);
        const leftGroup = values.filter(v => v < mean);
        
        if (rightGroup.length === 0 || leftGroup.length === 0) return 1;

        const meanR = rightGroup.reduce((a, b) => a + b, 0) / rightGroup.length;
        const meanL = leftGroup.reduce((a, b) => a + b, 0) / leftGroup.length;
        
        const deltaMeanR = Math.abs(meanR - mean);
        const deltaMeanL = Math.abs(meanL - mean);
        
        const madR = rightGroup.reduce((a, b) => a + Math.abs(b - mean), 0) / rightGroup.length;
        const madL = leftGroup.reduce((a, b) => a + Math.abs(b - mean), 0) / leftGroup.length;
        
        const nr = rightGroup.length;
        const nl = leftGroup.length;

        const numerator = D - (K * deltaMeanR) - (K * deltaMeanL) - (K * (madR * nr + madL * nl) / (nr + nl));
        const efi = S * (numerator / D) + 1;
        
        return efi.toFixed(3);
    }

    function updateAnalysis() {
        const S = parseFloat(document.getElementById('paramS').value);
        const D = parseFloat(document.getElementById('paramD').value);
        const K = parseFloat(document.getElementById('paramK').value);

        document.getElementById('arrowCount').innerText = arrows.length;

        if (arrows.length >= 2) {
            const efiX = calculateEFI(arrows.map(a => a.x), S, D, K);
            const efiY = calculateEFI(arrows.map(a => a.y), S, D, K);

            document.getElementById('efix').innerText = efiX;
            document.getElementById('efiy').innerText = efiY;
            document.getElementById('results').classList.remove('hidden');
            
            // 瞄準器建議 (假設跟隨箭頭走: 箭偏右，瞄準器往右調)
            const avgX = arrows.reduce((a, b) => a + b.x, 0) / arrows.length;
            const avgY = arrows.reduce((a, b) => a + b.y, 0) / arrows.length;
            
            let suggestX = avgX > 0.5 ? `瞄準器向【右】調 ${Math.abs(avgX).toFixed(1)} cm` : (avgX < -0.5 ? `瞄準器向【左】調 ${Math.abs(avgX).toFixed(1)} cm` : "水平不需調整");
            let suggestY = avgY > 0.5 ? `瞄準器向【上】調 ${Math.abs(avgY).toFixed(1)} cm` : (avgY < -0.5 ? `瞄準器向【下】調 ${Math.abs(avgY).toFixed(1)} cm` : "垂直不需調整");
            
            document.getElementById('suggestionText').innerHTML = `${suggestX}<br>${suggestY}`;
            document.getElementById('suggestionBox').classList.remove('hidden');
        }
    }

    function resetAll() {
        arrows = [];
        drawTarget();
        document.getElementById('results').classList.add('hidden');
        document.getElementById('suggestionBox').classList.add('hidden');
        document.getElementById('arrowCount').innerText = "0";
    }

    drawTarget();
</script>
</body>
</html>
